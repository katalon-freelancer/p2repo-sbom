# Vulnerability Integration Architecture

## System Overview

```
┌─────────────────────────────────────────────────────────────────────┐
│                         p2 SBOM Generator                           │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │              SBOMApplication.java                             │ │
│  │                                                               │ │
│  │  ┌─────────────────────────────────────────────────────┐    │ │
│  │  │ Injection Point 1: createAncestorComponent()        │    │ │
│  │  │   Input: Maven GAV, PURL                            │◄───┼─┼──┐
│  │  │   Use: Ancestor components                          │    │ │  │
│  │  └─────────────────────────────────────────────────────┘    │ │  │
│  │                                                               │ │  │
│  │  ┌─────────────────────────────────────────────────────┐    │ │  │
│  │  │ Injection Point 2: createMavenJarComponent()        │    │ │  │
│  │  │   Input: Maven GAV, Binary Hash                     │◄───┼─┼──┤
│  │  │   Use: Maven JAR components                         │    │ │  │
│  │  └─────────────────────────────────────────────────────┘    │ │  │
│  │                                                               │ │  │
│  │  ┌─────────────────────────────────────────────────────┐    │ │  │
│  │  │ Injection Point 3: setMavenPurl()                   │    │ │  │
│  │  │   Input: Maven GAV, PURL, Verified binary          │◄───┼─┼──┤
│  │  │   Use: Maven Central artifacts                      │    │ │  │
│  │  └─────────────────────────────────────────────────────┘    │ │  │
│  │                                                               │ │  │
│  │  ┌─────────────────────────────────────────────────────┐    │ │  │
│  │  │ Injection Point 4: getArtifactContent()             │    │ │  │ Query
│  │  │   Input: Hash values (SHA-1, SHA-256)               │◄───┼─┼──┤ CVE
│  │  │   Use: Non-Maven components                         │    │ │  │ Data
│  │  └─────────────────────────────────────────────────────┘    │ │  │
│  │                                                               │ │  │
│  │  ┌─────────────────────────────────────────────────────┐    │ │  │
│  │  │ Injection Point 5: gatherInformationFromPOM()       │    │ │  │
│  │  │   Input: Maven document (groupId, artifactId, ver)  │◄───┼─┼──┤
│  │  │   Use: After POM parsing                            │    │ │  │
│  │  └─────────────────────────────────────────────────────┘    │ │  │
│  │                                                               │ │  │
│  └───────────────────────────────────────────────────────────────┘ │  │
│                                                                     │  │
│  ┌───────────────────────────────────────────────────────────────┐ │  │
│  │              VulnerabilityQuerier (To Be Implemented)         │ │  │
│  │                                                               │ │  │
│  │  - Query by Maven GAV                                         │◄───┘
│  │  - Query by PURL                                              │
│  │  - Query by Hash                                              │
│  │  - Result caching                                             │
│  │  - Rate limiting                                              │
│  │  - Error handling                                             │
│  │                                                               │
│  └───────────────────────────────────────────────────────────────┘
│                              │                                      │
└──────────────────────────────┼──────────────────────────────────────┘
                               │
                               │ API Calls
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     CVE Data Sources (External)                     │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  OSV.dev     │  │  OSS Index   │  │  deps.dev    │            │
│  │  (Primary)   │  │  (PURL)      │  │  (Google)    │            │
│  │              │  │              │  │              │            │
│  │  • Maven ✓   │  │  • Maven ✓   │  │  • Maven ✓   │            │
│  │  • Hash ✓    │  │  • PURL ✓    │  │  • Hash ✗    │            │
│  │  • Free ✓    │  │  • Free ✓    │  │  • Free ✓    │            │
│  │  • No Auth ✓ │  │  • Rate Lim. │  │  • No Auth ✓ │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│                                                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐            │
│  │  GitHub      │  │     NVD      │  │    Snyk      │            │
│  │  Advisory    │  │   (NIST)     │  │              │            │
│  │              │  │              │  │              │            │
│  │  • Maven ✓   │  │  • Maven ✗   │  │  • Maven ✓   │            │
│  │  • Token ✓   │  │  • CPE only  │  │  • Token ✓   │            │
│  │  • GraphQL   │  │  • Free ✓    │  │  • Paid      │            │
│  └──────────────┘  └──────────────┘  └──────────────┘            │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
                               │
                               │ Returns
                               ▼
                    ┌──────────────────────┐
                    │  Vulnerability Data  │
                    │                      │
                    │  - CVE IDs           │
                    │  - CVSS Scores       │
                    │  - Severity Levels   │
                    │  - Descriptions      │
                    │  - References        │
                    │  - Affected Versions │
                    └──────────────────────┘
                               │
                               │ Embedded in
                               ▼
                    ┌──────────────────────┐
                    │  CycloneDX SBOM      │
                    │  (XML/JSON)          │
                    │                      │
                    │  <component>         │
                    │    <vulnerabilities> │
                    │      <vulnerability> │
                    │        <id>CVE-XXX   │
                    │        <rating>...   │
                    │      </vulnerability>│
                    │    </vulnerabilities>│
                    │  </component>        │
                    └──────────────────────┘
```

## Data Flow

### Phase 1: Component Creation
```
P2 Repository → Load IU → Create Component → Check for Maven Info
                                 │
                                 ├─ Has Maven GAV? → Query OSV by Maven
                                 │                    └─ Add vulnerabilities
                                 │
                                 ├─ Has PURL? → Query OSS Index by PURL
                                 │               └─ Add vulnerabilities
                                 │
                                 └─ Has Hash? → Query OSV by Hash
                                                 └─ Add vulnerabilities
```

### Phase 2: Vulnerability Query
```
Component Info → VulnerabilityQuerier → Check Cache
                                          │
                                          ├─ Cache Hit → Return cached data
                                          │
                                          └─ Cache Miss → Query API
                                                          │
                                                          ├─ Success → Store in cache
                                                          │            └─ Return data
                                                          │
                                                          └─ Failure → Log warning
                                                                       └─ Return empty
```

### Phase 3: Result Integration
```
Vulnerability Data → Convert to CycloneDX Format
                     │
                     ├─ Create Vulnerability object
                     ├─ Set ID (CVE-XXXX)
                     ├─ Set Source (OSV/OSS Index)
                     ├─ Add Rating (CVSS score)
                     ├─ Add Description
                     ├─ Add References
                     │
                     └─ component.addVulnerability(vuln)
```

## Implementation Layers

```
┌─────────────────────────────────────────────────────────────┐
│                      Layer 1: API Clients                   │
│  - OSVClient.java                                           │
│  - OSSIndexClient.java                                      │
│  - DepsDevClient.java                                       │
│  - Common interface: VulnerabilityDataSource                │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                 Layer 2: Query Coordinator                  │
│  - VulnerabilityQuerier.java                                │
│  - Route queries to appropriate sources                     │
│  - Deduplicate results                                      │
│  - Aggregate from multiple sources                          │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                    Layer 3: Caching                         │
│  - VulnerabilityCache.java                                  │
│  - File-based or memory cache                               │
│  - TTL management                                           │
│  - Cache invalidation                                       │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│                Layer 4: Format Conversion                   │
│  - VulnerabilityConverter.java                              │
│  - Convert OSV → CycloneDX                                  │
│  - Convert OSS Index → CycloneDX                            │
│  - Normalize severity levels                                │
└─────────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────────┐
│              Layer 5: Integration Points                    │
│  - SBOMApplication.java (existing code)                     │
│  - Call VulnerabilityQuerier at injection points            │
│  - Add results to Component objects                         │
└─────────────────────────────────────────────────────────────┘
```

## Configuration

### Command Line Options (Proposed)

```bash
# Enable vulnerability queries
--query-vulnerabilities

# Select data source
--vulnerability-source=osv              # OSV only (default)
--vulnerability-source=ossindex         # OSS Index only
--vulnerability-source=depsdev          # deps.dev only
--vulnerability-source=all              # All sources

# Caching
--vulnerability-cache-dir=/path/to/cache
--vulnerability-cache-ttl=86400         # 24 hours in seconds

# Performance
--vulnerability-timeout=30              # API timeout in seconds
--vulnerability-batch-size=50           # Batch query size
--vulnerability-max-parallel=5          # Max parallel queries

# Error handling
--vulnerability-fail-on-error=false     # Continue on API errors
```

### Configuration File (Optional)

```properties
# vulnerability.properties
vulnerability.enabled=true
vulnerability.sources=osv,ossindex
vulnerability.cache.dir=/tmp/vuln-cache
vulnerability.cache.ttl=86400
vulnerability.timeout=30
vulnerability.retry.max=3
vulnerability.retry.delay=1000
```

## Metrics and Monitoring

### Metrics to Track

```
┌─────────────────────────────────────────────┐
│         Vulnerability Query Metrics         │
├─────────────────────────────────────────────┤
│  - Total components processed               │
│  - Components with vulnerabilities found    │
│  - Total vulnerabilities discovered         │
│  - Critical severity count                  │
│  - High severity count                      │
│  - API calls made                           │
│  - Cache hit rate                           │
│  - API errors encountered                   │
│  - Average query time                       │
│  - Total processing time                    │
└─────────────────────────────────────────────┘
```

### Example Output

```
Vulnerability Query Summary:
  Components processed: 1,234
  Components with vulnerabilities: 89 (7.2%)
  Total vulnerabilities found: 156
    Critical: 12
    High: 34
    Medium: 67
    Low: 43
  
  API Statistics:
    Total queries: 1,234
    Cache hits: 789 (64%)
    Cache misses: 445 (36%)
    API errors: 3 (0.2%)
    Average query time: 234ms
    Total time: 4m 32s
```

## Security Considerations

### Rate Limiting
- Implement exponential backoff for rate limit errors
- Respect API terms of service
- Use authenticated APIs where available for higher limits

### Data Privacy
- Cache vulnerability data locally to reduce API calls
- Don't send sensitive internal component information to external APIs
- Only query public packages

### Error Handling
- Never fail SBOM generation due to vulnerability lookup errors
- Log all errors for debugging
- Provide clear error messages to users

## Future Enhancements

1. **Machine Learning**: Predict vulnerable components based on patterns
2. **Remediation Suggestions**: Include fix version recommendations
3. **Exploit Database**: Link to known exploits (ExploitDB)
4. **Custom Rules**: Allow users to define custom vulnerability rules
5. **Continuous Monitoring**: Re-scan SBOMs periodically for new CVEs
6. **Integration with Scanners**: Export to Dependency-Track, Grype, etc.

## References

- [CycloneDX Vulnerability Spec](https://cyclonedx.org/docs/1.6/json/#vulnerabilities)
- [OSV Schema](https://ossf.github.io/osv-schema/)
- [CVSS v3.1 Specification](https://www.first.org/cvss/v3.1/specification-document)
- [CWE Database](https://cwe.mitre.org/)
